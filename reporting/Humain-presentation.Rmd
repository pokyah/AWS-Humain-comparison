---
title: "Comparison of T° measurements @ Humain"
author: "Thomas Goossens (CRA-W) - t.goossens@cra.wallonie.be"
date: "`r format(Sys.time(), '%d %B, %Y')`"
always_allow_html: yes
output:
  revealjs::revealjs_presentation:
    center: yes
    highlight: pygments
    incremental: yes
    self_contained: true
    slide_level: 2
    theme: solarized
    transition: slide
    reveal_options:
      previewLinks: false
  md_document:
    toc: no
    toc_depth: 6
    variant: markdown_github
  word_document:
    toc: no
    toc_depth: '6'
  pdf_document: default
  odt_document:
    fig_height: 5
    fig_width: 7
  html_document:
    theme: default
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---

```{r setup, include=FALSE}
#+ ---------------------------------
#' ## Script preparation
#' 
#+ preparation, echo=TRUE, warning=FALSE, message=FALSE, error=FALSE, results='asis'

# Avoid interference with old variables by cleaning the Global Environment
rm(list=ls(all=TRUE))

# Automagically set the wd and the root of all projects 
if (!require("here")) install.packages("here")
library(here)
wd.chr <- here::here()
require(plotly)
require(knitr)
require(broom)

# Defining the .Rmd settings - https://github.com/yihui/knitr/issues/277
knitr::opts_chunk$set(
echo = FALSE,
warning= FALSE,
error= FALSE,
message= FALSE)

# Loading the .RData generared by the .init file
load(file= paste0(wd.chr,"/data-output/big_bmr.RData"))
#source(paste0(wd.chr,"/init.R"))

#integrate font awesome
htmltools::tagList(rmarkdown::html_dependency_font_awesome())
```

# todolist

* normalize
* Tester la différence sur les daily max
* Clearness index ==> filtre dataset original pour les valeurs >0.6 ou seuil au-delà duquel,n 30% d'observations (correspondent à périodes d'effets radiatifs)
* apprendre le modèle sur base de cce jue filtré
* Valider le modèles sur les daily max
* Comparaison daily max corr et originaux
* Recréer une série temporelle continue en réintégrant les data nondaily maxima
* comparer les paires de stations proches pour l'ensoleillement pour voir si le modèle est transposable
* Aussi faire une validation sur les data nov a avril 2018

# Context & objectives

## Integration of the RMI + Pameseb AWS networks

* Agromet : providing hourly gridded (1km²) weather datasets for agricultural decision support system  
* Possibility of RMI stations integration for better spatialization ==> interoperability ?   

## Assessing the agreement level between the 2 types of AWS

* previous [work](http://onlinelibrary.wiley.com/doi/10.1002/wea.2158/pdf) by Geoff Jenkins described a comparison method based on regression model correlation study.
* as demonstrated by [Giavarina](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4470095/), correlation studies is not appropriate to study the differences.
* The alternative [Bland-Altman analysis](https://www-users.york.ac.uk/~mb55/meas/ba.pdf) proposed by the authors is used in this study.


# Data presentation

## Period of interest

2 years of hourly records at Humain from `01-nov-2015` to `01-nov-2017` 

## Statistics : 

```{r}
kable(no_extra_filter$statistics.l$tsa_stats.df, caption= "tsa summary stats", digits=2)
```

## Time series
```{r fig.cap = "Time series"}
no_extra_filter$plots$timeseries.plot$tsa.time.plot
```

## Density
```{r fig.cap = "Density"}
no_extra_filter$plots$densities.plot$tsa.dens.plot
```

## Scatter
```{r fig.cap = "Scatter plot"}
no_extra_filter$plots$scatters.plot$tsa.scatter.plot
```

# First insights

## Similarity

Datasets seem in accordance ...

* but to which extent ? 
* How can we quantify this degree of similarity ?  
* Even if a certain degree of similarity : Pameseb seems warmer

## Temperature difference investigation

<i class="fa fa-question-circle"></i>

What can be infered by studying the temperature differences rather than their correlation ?

# Investigating the temperature difference

## Bland-Altman analysis - concept

We can use a [Bland Altman analysis](https://pokyah.github.io/howto/assessing-the-agreement-between-2-quantitative-methods-of-measurements-understanding-the-Bland-Altman-analysis/) to measure the agreement level between the 2 stations

It consists to take observations pair by pair and to plot their `means` vs. their `differences`.

In our case we choose to plot `IRM <i class="fa fa-minus-circle"></i> Pameseb`.

## IRM - Pameseb BA Plot

```{r Plot of mean tsa vs. tsaPameseb - tsaIRM}
no_extra_filter$blandAltman$bland_altman.plot
```

## BA plot interpretation

* For most individuals, measurements made by 2 stations are more likely to be far apart between [`r signif(no_extra_filter$blandAltman$bland_altman.stats.df[1,2], 2)` ; `r signif(no_extra_filter$blandAltman$bland_altman.stats.df[1,4], 2)`] °C.

* 0 is not in the 95% CI of the mean difference [`r signif(no_extra_filter$blandAltman$bland_altman.stats.df[2,6], 2)` ; `r signif(no_extra_filter$blandAltman$bland_altman.stats.df[4,6], 2)` ] <i class="fa fa-hand-point-right"></i> It exists a mean negative __bias__ of `r signif(no_extra_filter$blandAltman$bland_altman.stats.df[1,3],2)`

* The scatter presents a trend going from positive bias to negative bias <i class="fa fa-hand-point-right"></i> proportional bias. The methods do not agree equally through the range of measurements. The highest absolute differences are observed the highest mean temperatures.

* below 10 °C, IRM tends to be warmer (T°diff fluctuates above 0°C) and above 10°C, Pameseb tends to be warmer (T°diff flucutuates below 0°C)

## A potential explanation : station design

The 2 stations are actually different in their design. While the __RMI__ is equipped with a Stevenson radiation screeen mechanically ventiled, __Pameseb__ is equipped with a custom screen without mechanical ventilation

![](./assets/shelters.png){ width=50% }

# Potential effect of the mechanical ventilation

## Supposition

> the lack of ventilation system at Pameseb does not allow to sufficiently compensate the effect of direct solar radiation, leading to an overheating of the Pameseb shelter compared to RMI during situations of high irradiance and low wind.

If `TRUE` and `sufficient` :  

The negative differences should be inexistant or at least less pronounced at __night__

## IRM - Pameseb BA Plot : Night_only situations
```{r}
night_only$blandAltman$bland_altman.plot
```

## BA plot interpretation : Night_only situations

* For most individuals, measurements made by 2 stations are more likely to be far apart in a narrower range comprised between [`r signif(night_only$blandAltman$bland_altman.stats.df[1,2], 2)` ; `r signif(night_only$blandAltman$bland_altman.stats.df[1,4], 2)`] °C.  

* 0 is not in the 95% CI of the mean difference [`r signif(night_only$blandAltman$bland_altman.stats.df[2,6], 2)` ; `r signif(night_only$blandAltman$bland_altman.stats.df[4,6], 2)` ] <i class="fa fa-hand-point-right"></i> It exists a mean positif __bias__ of `r signif(night_only$blandAltman$bland_altman.stats.df[1,3],2)` (IRM warmer than Pameseb this time)

* The scatter still presents a trend going from positive bias to negative bias.

* <i class="fa fa-hand-point-right"></i> The ventilation system is not the only explanation to the proportional bias. The sensitivity of the sensors themselves (and/or non-linear differences in radiation transfer effects from the shelters towards the sensors) could also possibly exlpain the observed differences.

# Solving the disagreement

## Idea

* Applying a temperature correction model to Pameseb stations Prior to the integration of the 2 networks in the spatialization process (We consider RMI as the gold-standard)

* The value of the correction to apply to each observation will be predicted by a correction model able to predict the observed temperature difference from any combination of `wind speed`, `irradiance` and `temperature` measured at Pameseb :  
`corr_pameseb_temp = RMI_temp + predicted_temp_diff`

## Validation strategies

Regarding what we have learned from the Bland-Altman plots, we can use 2 validation strategies : 

- one that train our various model on observations corresponding to `High Clearness index` values (`ci > q70(ci)`) and test these on observations corresponding to `[-2h; daily max ; +2h]` : focusing on the effect of the mechanical ventilation

- another one that randomly split the dataset on a training set and a test set : non-specific approach of the temperature difference 

## Predictive performance of the models : High CI

```{r}
plotBMRSummary(hci.bmr.l)
```

## Predictive performance of the models : Random split

```{r}
plotBMRSummary(rnd.bmr.l)
```

## Predictive performance of the models : interpretation

In both cases (random split and High CI validations), the model that presents the lowest mean square error is the one using the 3 variables (`wind speed`, `irradiance` and `temperature`) as predictors.

For the random split, the learner that performs the best is the linear regression with a mse of `r getBMRAggrPerformances(rnd.bmr.l)$regr.all.rnd$regr.lm`

For the high CI, the learner that performs the best is the Fast k-Nearest Neighbor with a mse of `r getBMRAggrPerformances(hci.bmr.l)$regr.all.hci$regr.fnn`


## Correction results
It seems that the model cannot efficiently make the correction for the high temperature.
Maybe should we only compute a model on a subset of the whole dataframe and apply it only on these cases


# Conclusions, perspectives and colofon

## Conclusions

* prior to spatialization, a correction model needs to be applied before integrating the 2 networks

## Perspectives
* Once finished, we plan to submit this work to the ["Weather" Journal of the RMETS](http://rmets.onlinelibrary.wiley.com/hub/journal/10.1002/(ISSN)1477-8696/aims-and-scope/read-full-aims-and-scope.html).
* title idea : 
  > Quantitative intercomparison of 2 years hourly records of temperature and relative
    humidity measured by 2 different types of professional-grade automatic weather stations
    at Humain, Belgium

## Colofon
* This report is still in major revision phase. __Consider it as a first draft version__.  
* This document was generated using R software with the [knitr library](https://deanattali.com/2015/03/24/knitrs-best-hidden-gem-spin/) 
* The interactive plots are rendered from ggplot by [plotly](https://plot.ly).
* The model definition was performed using the [mlr package](https://mlr-org.github.io)
* The source code of the analysis and this presentation is availbale on [github](https://github.com/pokyah/AWS-Humain-comparison)


## Terms of service 
To use the [AGROMET API](https://app.pameseb.be/fr/pages/api_call_test/) you need to provide your own user token.  
The present script is available under the [GNU-GPL V3](https://www.gnu.org/licenses/gpl-3.0.en.html) license and comes with ABSOLUTELY NO WARRANTY.

Copyright : Thomas Goossens - t.goossens@cra.wallonie.be 2018.  
 
*(This document was generated using [R software](https://www.r-project.org/) with the [knitr library](https://deanattali.com/2015/03/24/knitrs-best-hidden-gem-spin/))*.  

<script>
  $(document).ready(function() {
    $items = $('div#TOC li');
    $items.each(function(idx) {
      num_ul = $(this).parentsUntil('#TOC').length;
      $(this).css({'text-indent': num_ul * 10, 'padding-left': 
          0});
    });
    
  });
</script>
  
  
  
  
  
  
  