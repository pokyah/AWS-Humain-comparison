---
title: "Comparison of T° measurements @ Humain"
author: "Thomas Goossens (CRA-W) - t.goossens@cra.wallonie.be"
date: "`r format(Sys.time(), '%d %B, %Y')`"
always_allow_html: yes
output:
  html_document:
    theme: default
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
      smooth_scroll: yes
  md_document:
    toc: no
    toc_depth: 6
    variant: markdown_github
  word_document:
    toc: no
    toc_depth: '6'
  pdf_document: default
  odt_document:
    fig_height: 5
    fig_width: 7
  revealjs::revealjs_presentation:
    center: yes
    highlight: pygments
    incremental: yes
    self_contained: yes
    slide_level: 2
    theme: solarized
    transition: fade
---

```{r setup, include=FALSE}
#+ ---------------------------------
#' ## Script preparation
#' 
#+ preparation, echo=TRUE, warning=FALSE, message=FALSE, error=FALSE, results='asis'

# Avoid interference with old variables by cleaning the Global Environment
rm(list=ls(all=TRUE))

# Automagically set the wd and the root of all projects 
if (!require("here")) install.packages("here")
library(here)
wd.chr <- here::here()
require(plotly)
require(knitr)
require(broom)

# Defining the .Rmd settings - https://github.com/yihui/knitr/issues/277
knitr::opts_chunk$set(
echo = FALSE,
warning= FALSE,
error= FALSE,
message= FALSE)

# Loading the .RData generared by the .init file
load(file= paste0(wd.chr,"/data-output/report_data_various_filters.RData"))
#source(paste0(wd.chr,"/init.R"))

#integrate font awesome
htmltools::tagList(rmarkdown::html_dependency_font_awesome())
```

# Context & objectives <i class="fa fa-file"></i>

## Integration of the RMI + Pameseb AWS networks

* Agromet : providing hourly gridded (1km²) weather datasets for agricultural decision support system  
* Possibility of RMI stations integration for better spatialization ==> interoperability ?   

## Assessing the agreement level between the 2 types of AWS

* previous [work](http://onlinelibrary.wiley.com/doi/10.1002/wea.2158/pdf) by Geoff Jenkins described a comparison method based on regression model correlation study.
* as demonstrated by [Giavarina](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4470095/), correlation studies is not appropriate to study the differences.
* The alternative [Bland-Altman analysis](https://www-users.york.ac.uk/~mb55/meas/ba.pdf) proposed by the authors is used in this study.


# Data presentation

## Statistics : 

```{r}
kable(no_extra_filter$statistics.l$tsa_stats.df, caption= "tsa summary stats", digits=2)
```

## Time series
```{r fig.cap = "Time series"}
no_extra_filter$plots$timeseries.plot$tsa.time.plot
```

## Density
```{r fig.cap = "Density"}
no_extra_filter$plots$densities.plot$tsa.dens.plot
```

## Scatter
```{r fig.cap = "Scatter plot"}
no_extra_filter$plots$scatters.plot$tsa.scatter.plot
```


# First insights

## Similarity

Datasets seem in accordance ...

* but to which extent ? 
* How can we quantify this degree of similarity ?  
* Even if a certain degree of similarity : Pameseb seems warmer

## Temperature difference investigation

What can be infered by studying the temperature differences rather than their correlation ?

# Investigating the temperature difference

## Bland-Altman analysis

We can use a [Bland Altman analysis](https://pokyah.github.io/howto/assessing-the-agreement-between-2-quantitative-methods-of-measurements-understanding-the-Bland-Altman-analysis/) to measure the agreement level between the 2 stations.

It consists to take observations pair by pair, and plot their means vs. their differences.

In our case we choose to plot `IRM - Pameseb`.

## Vizualizing Bland-Altman analyis

```{r Plot of mean tsa vs. tsaPameseb - tsaIRM}
no_extra_filter$blandAltman$bland_altman.plot
```

## What the Bland-Altman plot tells us ?

* For most individuals, measurements made by 2 stations are more likely to be far apart between [`r signif(no_extra_filter$blandAltman$bland_altman.stats.df[1,2], 2)` - `r signif(no_extra_filter$blandAltman$bland_altman.stats.df[1,4], 2)`] °C.

* 0 is not in the 95% CI of the mean difference [`r signif(no_extra_filter$blandAltman$bland_altman.stats.df[2,6], 2)` - `r signif(no_extra_filter$blandAltman$bland_altman.stats.df[4,6], 2)` ] ==> It exists a systematic positif __bias__ of `r signif(no_extra_filter$blandAltman$bland_altman.stats.df[1,3],2)` 

* Considering the limits of agreement CI [`r signif(no_extra_filter$blandAltman$bland_altman.stats.df[1,5],2)` and `r signif(no_extra_filter$blandAltman$bland_altman.stats.df[6,5],2)`], we can tell that we are 95 % certain that the methods do not disagree (if maximum allowed difference is 1°C)

* The scatter presents a trend going from positive bias to negative bias ==> proportional bias. The methods do not agree equally through the range of measurements. 

* The RMI - Pameseb temperature differences are negatively correlated with the temperature means.


## Plausible hypothesis to investigate

The 2 stations are actually different in their design. While the __RMI__ is equipped with a __Stevenson radiation screeen mechanically ventiled__, __Pameseb is equipped with a __custom screen without mechanical ventilation__

We can assume that it exists :

1.  an overheating of the Pameseb shelter compared to RMI during periods of __High irradiance and low wind__ due to the lack of ventilation system at Pameseb that may significantly increase the measured temperature.  

2. an overcooling of the RMI shelter compared to Pameseb during periods of __Low irradiance + stratified air__ situation due to the fact that the ventilation pumps air located 50 cm below the temperature sensor.  
  
## Visualising the 2 designs

![](./assets/shelters.png){ width=50% }

# Questioning the potential effect of the ventilation

## Strategy

We can filter the dataset to only keep records corresponding to specific situations : 

* Do we still see a positif bias What happens when we are in situations of low irradiance ang high wind ? `vvt > vvt_mean && ens < 100`
* Do we see the same trend in temperature differences when considering situations of __low irradiance and high-wind__ situations only ?
* Filtering the dataset by keeping situations where : `vvt > vvt_mean && ens < 100`

## Low irradiance and high wind BA Plot
```{r}
low_rad_high_wind$blandAltman$bland_altman.plot
```

## What the Low irradiance and high wind BA plot tells us ?

* It exists a systematic __bias__ of `r low_rad_high_wind$blandAltman$bland_altman.stats.df[1,3]`

* The __limits of agreement__ are `r low_rad_high_wind$blandAltman$bland_altman.stats.df[1,2]` and `r low_rad_high_wind$blandAltman$bland_altman.stats.df[1,4]` °C. *These lines tell us how far apart measurements by 2 methods were more likely to be for most individuals.* 

* Considering the limits of agreement CI (`r low_rad_high_wind$blandAltman$bland_altman.stats.df[1,5]` and `r low_rad_high_wind$blandAltman$bland_altman.stats.df[6,5]` ), we can tell that we are 95 % certain that the methods do not disagree (if maximum allowed difference is 1°C)

* The differences are still present but are clearly __less important__. Some discrepancies due to outliers

* Even with no irradiance, the rising trend is still present. How can this be ? According to RMI, the ventilation system pumps up air 50 cm below the sensor. While the atmosphere is stratified, the RMI shelter might be ventiled with colder air than the one it is supposed to measure...

* ==> So the rising trend might also be due to an artifical "over-cooling" rather than the combined effect of high irradiance + low wind only

## Statistics of the Low irradiance and high wind

```{r}
kable(low_rad_high_wind$statistics.l$tsa_stats.df, caption= "low irradiance & high wind tsa summary stats", digits=2)
```

Strangely, IRM is globally __warmer__ 

* even if the temperature difference for high mean temperature is stil positive (`T°pameseb > T°IRM`) !
* even it might be subject to artifical over-cooling when the air is stratified
* ==> Hypothesis : when the shelters stop to receive direct solar radiation, we might expect that the Pameseb one cools quicker due to its less important inertia ?

## Considering the high irradiance and low wind situations  

We can have a quick comparative lookat the __low-wind and high irradiance__ situtions only to better grasp the effect of ventilation 

## High Irradiance & Low wind Balnd-Altman 

```{r}
high_rad_low_wind$blandAltman$bland_altman.plot
```

## What the High irradiance and low wind BA plot tells us ?

* The highest temperature discrepencies are 
* Learn outputs of BA stats

==> __prior to the integration of the 2 networks in the spatialization process, a correction model needs to be applied to the temperature data produced by the CRA-W AWS ne2rk__.

## Summarizing the examination of a ventilation mechanism

* IRM temperature tends to be smaller when low temperature situations (<5°C) whatever the wind and irradiance conditions ("over-cooling" by pumping colder stratified air ?)
* Pameseb temperature tends to be higher when high temperature situations () only during low wind and high irradiance situations (lack of mechanical ventilation)
* more more ! Pay attention to axis, etc !!! A lot to say

# Solving the disagreement

## Strategy

We can build a temperature correction model based on irradiance and wind speed conditions


# Conclusions, perspectives and colofon

## Conclusions

* prior to spatialization, a correction model needs to be applied before integrating the 2 networks

## Perspectives
* Once finished, we plan to submit this work to the ["Weather" Journal of the RMETS](http://rmets.onlinelibrary.wiley.com/hub/journal/10.1002/(ISSN)1477-8696/aims-and-scope/read-full-aims-and-scope.html).
* title idea : 
  > Quantitative intercomparison of 2 years hourly records of temperature and relative
    humidity measured by 2 different types of professional-grade automatic weather stations
    at Humain, Belgium

## Colofon
* This report is still in major revision phase. __Consider it as a first draft version__.  
* This document was generated using R software with the [knitr library](https://deanattali.com/2015/03/24/knitrs-best-hidden-gem-spin/) 
* The interactive plots are rendered from ggplot by [plotly](https://plot.ly).
* The source code of the analysis and this presentation is availbale on [github](https://github.com/pokyah/AWS-Humain-comparison)


<script>
  $(document).ready(function() {
    $items = $('div#TOC li');
    $items.each(function(idx) {
      num_ul = $(this).parentsUntil('#TOC').length;
      $(this).css({'text-indent': num_ul * 10, 'padding-left': 
          0});
    });
    
  });
</script>
  
  
  
  
  
  
  